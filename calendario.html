
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Semanal Seguro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.filtro-activo { background-color: #4CAF50; color: white; font-weight: bold; }
#auth-section { margin-bottom: 15px; }
.hidden { display: none; }
</style>
</head>

<body>

<h2>Calendario semanal</h2>

<!-- Autenticación (requerida para RLS) -->
<div id="auth-section">
    <button id="btn-login" onclick="login()">Iniciar Sesión</button>
    <button id="btn-logout" onclick="logout()" class="hidden">Cerrar Sesión</button>
    <p id="user-info"></p>
</div>

<!-- Filtros (ahora server-side) -->
<div style="margin-bottom: 15px;">
    <label>Paciente:</label>
    <select id="filtroPaciente">
        <option value="todos">Todos</option>
    </select>

    <button id="btn_mañana" onclick="toggleFiltro('mañana')">Mañana</button>
    <button id="btn_tarde" onclick="toggleFiltro('tarde')">Tarde</button>
    <button id="btn_control" onclick="toggleFiltro('control')">Control</button>

    <button onclick="limpiarFiltros()">Limpiar filtros</button>
</div>

<button onclick="semanaAnterior()">⬅️ Semana anterior</button>
<button onclick="semanaSiguiente()">➡️ Semana siguiente</button>

<div id="calendario" style="margin-top:20px;"></div>

<script>
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
// NO EXPONER SUPABASE_KEY en prod - usa session de auth
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let fechaActual = new Date();
let session = null;
let filtros = { mañana: false, tarde: false, control: false, paciente: "todos" };

// Manejo de Auth
async function initAuth() {
    session = await client.auth.getSession();
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userInfo = document.getElementById('user-info');

    if (session.data.session) {
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
        userInfo.textContent = `Usuario: ${session.data.session.user.email}`;
        cargarPacientes(); // Solo si autenticado
        verSemana();
    } else {
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
        userInfo.textContent = 'Inicia sesión para ver datos';
    }

    // Listener para cambios de auth
    client.auth.onAuthStateChange((event, sess) => {
        session = sess;
        initAuth();
    });
}

async function login() {
    await client.auth.signInWithOAuth({ provider: 'google' }); // O email/password
}

async function logout() {
    await client.auth.signOut();
    filtros.paciente = "todos"; // Reset
    document.getElementById("filtroPaciente").innerHTML = '<option value="todos">Todos</option>';
}

// Cargar pacientes (solo autenticados, con RLS)
async function cargarPacientes() {
    if (!session.data.session) return;
    const { data } = await client.from("pacientes").select("id, nombre").order("nombre");
    const sel = document.getElementById("filtroPaciente");
    sel.innerHTML = '<option value="todos">Todos</option>'; // Reset
    data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        sel.appendChild(opt);
    });
    sel.onchange = () => { filtros.paciente = sel.value; verSemana(); };
}

// Toggle filtros
function toggleFiltro(campo) {
    filtros[campo] = !filtros[campo];
    document.getElementById("btn_" + campo).classList.toggle("filtro-activo", filtros[campo]);
    verSemana();
}

function limpiarFiltros() {
    Object.keys(filtros).forEach(k => filtros[k] = k === 'paciente' ? 'todos' : false);
    document.getElementById("filtroPaciente").value = "todos";
    document.querySelectorAll('[id^="btn_"]').forEach(btn => btn.classList.remove("filtro-activo"));
    verSemana();
}

// Query server-side con filtros (eficiente)
async function cargarSemana(fechaBase) {
    if (!session.data.session) return [];
    const fecha = new Date(fechaBase);
    const lunes = new Date(fecha); lunes.setDate(fecha.getDate() - fecha.getDay() + 1);
    const viernes = new Date(lunes); viernes.setDate(lunes.getDate() + 4);
    const f1 = lunes.toISOString().split("T")[0];
    const f2 = viernes.toISOString().split("T")[0];

    let query = client.from("registros_diarios").select("*, pacientes(nombre)").gte("fecha", f1).lte("fecha", f2).order("fecha");

    // Filtros server-side
    if (filtros.paciente !== "todos") query.eq("paciente_id", filtros.paciente);
    if (filtros.mañana) query.eq("mañana", true);
    if (filtros.tarde) query.eq("tarde", true);
    if (filtros.control) query.eq("control", true);

    const { data } = await query;
    return data || [];
}

// Resto igual: agrupar, mostrar...
function agrupar(registros) {
    const dias = {};
    registros.forEach(r => {
        if (!dias[r.fecha]) dias[r.fecha] = [];
        dias[r.fecha].push(r);
    });
    return dias;
}

function mostrar(diasSemana) {
    const cont = document.getElementById("calendario");
    cont.innerHTML = `<p><strong>Semana del ${Object.keys(diasSemana).sort()[0] || ''}</strong></p>`;
    // ... (mismo código de tabla que original, sin filtros client-side ya que se aplican en server)
    const diasOrden = ["lunes","martes","miércoles","jueves","viernes"];
    const tabla = document.createElement("table");
    tabla.style.width = "100%"; tabla.style.borderCollapse = "collapse";

    const head = document.createElement("tr");
    diasOrden.forEach(d => {
        const th = document.createElement("th");
        th.textContent = d.toUpperCase();
        th.style.border = "1px solid #ccc"; th.style.padding = "8px"; th.style.background = "#f0f0f0";
        head.appendChild(th);
    });
    tabla.appendChild(head);

    const fila = document.createElement("tr");
    const fechas = Object.keys(diasSemana).sort();

    diasOrden.forEach((_, i) => {
        const celda = document.createElement("td");
        celda.style.border = "1px solid #ccc"; celda.style.padding = "8px"; celda.style.verticalAlign = "top";

        const fecha = fechas[i];
        if (fecha) {
            const titulo = document.createElement("div");
            titulo.textContent = fecha; titulo.style.fontWeight = "bold"; titulo.style.marginBottom = "6px";
            celda.appendChild(titulo);

            diasSemana[fecha].forEach(r => {
                const p = document.createElement("div");
                p.style.background = "#eef5d0"; p.style.padding = "4px"; p.style.marginBottom = "6px"; p.style.borderRadius = "4px";
                p.textContent = `${r.pacientes?.nombre || "Sin nombre"} — Mañana: ${r.mañana ? 'SÍ' : 'NO'} — Tarde: ${r.tarde ? 'SÍ' : 'NO'} — Control: ${r.control ? 'SÍ' : 'NO'}`;
                celda.appendChild(p);
            });
        }
        fila.appendChild(celda);
    });

    tabla.appendChild(fila);
    cont.appendChild(tabla);
}

async function verSemana() {
    if (!session.data.session) return;
    const registros = await cargarSemana(fechaActual);
    const dias = agrupar(registros);
    mostrar(dias);
}

function semanaAnterior() { fechaActual.setDate(fechaActual.getDate() - 7); verSemana(); }
function semanaSiguiente() { fechaActual.setDate(fechaActual.getDate() + 7); verSemana(); }

// Inicializar
initAuth();
</script>

</body>
</html>




