<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Semanal Completo</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.filtro-activo { background-color: #4CAF50; color: white; font-weight: bold; }
#auth-section { margin-bottom: 15px; }
.hidden { display: none; }
.dia-semana { font-weight: bold; margin-bottom: 6px; }
</style>
</head>

<body>

<h2>Calendario semanal</h2>

<!-- Autenticación -->
<div id="auth-section">
    <button id="btn-login" onclick="login()">Iniciar Sesión</button>
    <button id="btn-logout" onclick="logout()" class="hidden">Cerrar Sesión</button>
    <p id="user-info"></p>
</div>

<!-- Filtros -->
<div style="margin-bottom: 15px;">
    <label>Paciente:</label>
    <select id="filtroPaciente">
        <option value="todos">Todos</option>
    </select>
    <button id="btn_mañana" onclick="toggleFiltro('mañana')">Mañana</button>
    <button id="btn_tarde" onclick="toggleFiltro('tarde')">Tarde</button>
    <button id="btn_control" onclick="toggleFiltro('control')">Control</button>
    <button onclick="limpiarFiltros()">Limpiar filtros</button>
</div>

<button onclick="semanaAnterior()">⬅️ Semana anterior</button>
<span id="rango-semana"></span>
<button onclick="semanaSiguiente()">➡️ Semana siguiente</button>

<div id="calendario" style="margin-top:20px;"></div>

<script>
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let fechaActual = new Date();
let session = null;
let filtros = { mañana: false, tarde: false, control: false, paciente: "todos" };

const DIAS_SEMANA = ["lunes", "martes", "miércoles", "jueves", "viernes", "sábado", "domingo"];

// Auth (mismo que antes)
async function initAuth() {
    const {  { session: sess } } = await client.auth.getSession();
    session = sess;
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userInfo = document.getElementById('user-info');

    if (session) {
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
        userInfo.textContent = `Usuario: ${session.user.email}`;
        cargarPacientes();
        verSemana();
    } else {
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
        userInfo.textContent = 'Inicia sesión para ver datos';
    }

    client.auth.onAuthStateChange((_, sess) => {
        session = sess; initAuth();
    });
}

async function login() { await client.auth.signInWithOAuth({ provider: 'google' }); }
async function logout() { await client.auth.signOut(); }

// Cargar pacientes (mismo)
async function cargarPacientes() {
    if (!session) return;
    const { data } = await client.from("pacientes").select("id, nombre").order("nombre");
    const sel = document.getElementById("filtroPaciente");
    sel.innerHTML = '<option value="todos">Todos</option>';
    data?.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.nombre;
        sel.appendChild(opt);
    });
    sel.onchange = () => { filtros.paciente = sel.value; verSemana(); };
}

// Filtros (mismo)
function toggleFiltro(campo) {
    filtros[campo] = !filtros[campo];
    document.getElementById("btn_" + campo).classList.toggle("filtro-activo", filtros[campo]);
    verSemana();
}

function limpiarFiltros() {
    Object.keys(filtros).forEach(k => filtros[k] = k === 'paciente' ? 'todos' : false);
    document.getElementById("filtroPaciente").value = "todos";
    document.querySelectorAll('[id^="btn_"]').forEach(btn => btn.classList.remove("filtro-activo"));
    verSemana();
}

// **CÁLCULO CORREGIDO: SEMANA COMPLETA LUNES-DOMINGO**
function calcularFechasSemana(fechaBase) {
    const fecha = new Date(fechaBase);
    const diaSemana = fecha.getDay() === 0 ? 7 : fecha.getDay(); // Domingo=7
    const lunes = new Date(fecha);
    lunes.setDate(fecha.getDate() - (diaSemana - 1)); // Primer lunes
    const fechas = [];
    for (let i = 0; i < 7; i++) {
        const f = new Date(lunes);
        f.setDate(lunes.getDate() + i);
        fechas.push(f.toISOString().split('T')[0]);
    }
    return fechas;
}

// Cargar semana **con todas las fechas**
async function cargarSemana(fechaBase) {
    if (!session) return [];
    const fechasSemana = calcularFechasSemana(fechaBase);
    const f1 = fechasSemana[0];
    const f2 = fechasSemana[6];

    let query = client
        .from("registros_diarios")
        .select("*, pacientes(nombre)")
        .gte("fecha", f1)
        .lte("fecha", f2)
        .order("fecha");

    if (filtros.paciente !== "todos") query.eq("paciente_id", filtros.paciente);
    if (filtros.mañana) query.eq("mañana", true);
    if (filtros.tarde) query.eq("tarde", true);
    if (filtros.control) query.eq("control", true);

    const { data } = await query;
    return data || [];
}

function agrupar(registros) {
    const dias = {};
    registros.forEach(r => {
        if (!dias[r.fecha]) dias[r.fecha] = [];
        dias[r.fecha].push(r);
    });
    return dias;
}

// Mostrar **7 columnas**
function mostrar(diasSemana) {
    const cont = document.getElementById("calendario");
    cont.innerHTML = "";
    
    // Rango semana
    const fechasSemana = calcularFechasSemana(fechaActual);
    document.getElementById("rango-semana").textContent = 
        ` (${fechasSemana[0]} al ${fechasSemana[6]})`;

    const tabla = document.createElement("table");
    tabla.style.width = "100%"; tabla.style.borderCollapse = "collapse";

    // Headers 7 días
    const head = document.createElement("tr");
    DIAS_SEMANA.forEach(dia => {
        const th = document.createElement("th");
        th.textContent = dia.toUpperCase();
        th.style.border = "1px solid #ccc"; th.style.padding = "8px"; th.style.background = "#f0f0f0";
        head.appendChild(th);
    });
    tabla.appendChild(head);

    const fila = document.createElement("tr");

    // 7 celdas
    fechasSemana.forEach(fechaISO => {
        const celda = document.createElement("td");
        celda.style.border = "1px solid #ccc"; celda.style.padding = "8px"; celda.style.verticalAlign = "top"; celda.style.minHeight = "200px";

        const fecha = new Date(fechaISO);
        const diaSemanaIdx = fecha.getDay() === 0 ? 6 : fecha.getDay() - 1;
        const nombreDia = DIAS_SEMANA[diaSemanaIdx];

        const titulo = document.createElement("div");
        titulo.className = "dia-semana";
        titulo.innerHTML = `<strong>${nombreDia}<br>${fechaISO}</strong>`;
        celda.appendChild(titulo);

        const registros = diasSemana[fechaISO] || [];
        registros.forEach(r => {
            const p = document.createElement("div");
            p.style.background = "#eef5d0"; p.style.padding = "4px"; p.style.marginBottom = "4px"; p.style.borderRadius = "4px"; p.style.fontSize = "0.9em";
            p.textContent = `${r.pacientes?.nombre || "Sin nombre"} (${r.mañana?'M':''}${r.tarde?'T':''}${r.control?'C':''})`;
            celda.appendChild(p);
        });

        fila.appendChild(celda);
    });

    tabla.appendChild(fila);
    cont.appendChild(tabla);
}

async function verSemana() {
    if (!session) return;
    const registros = await cargarSemana(fechaActual);
    const dias = agrupar(registros);
    mostrar(dias);
}

function semanaAnterior() { fechaActual.setDate(fechaActual.getDate() - 7); verSemana(); }
function semanaSiguiente() { fechaActual.setDate(fechaActual.getDate() + 7); verSemana(); }

initAuth();
</script>

</body>
</html>




