<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Semanal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.filtro-activo {
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>Calendario semanal</h2>

<!-- Filtros -->
<div style="margin-bottom: 15px;">

    <label>Paciente:</label>
    <select id="filtroPaciente">
        <option value="todos">Todos</option>
    </select>

    <button id="btn_mañana" onclick="toggleFiltro('mañana')">Mañana</button>
    <button id="btn_tarde" onclick="toggleFiltro('tarde')">Tarde</button>
    <button id="btn_control" onclick="toggleFiltro('control')">Control</button>

    <button onclick="limpiarFiltros()">Limpiar filtros</button>

</div>

<button onclick="semanaAnterior()">⬅️ Semana anterior</button>
<button onclick="semanaSiguiente()">➡️ Semana siguiente</button>

<div id="calendario" style="margin-top:20px;"></div>

<script>
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Fecha interna del calendario
let fechaActual = new Date();

// Filtros activos
let filtros = {
    mañana: false,
    tarde: false,
    control: false,
    paciente: "todos"
};

// Cargar lista de pacientes
async function cargarPacientes() {
    const { data } = await client
        .from("pacientes")
        .select("id, nombre")
        .order("nombre", { ascending: true });

    const sel = document.getElementById("filtroPaciente");

    data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        sel.appendChild(opt);
    });

    sel.onchange = () => {
        filtros.paciente = sel.value;
        verSemana();
    };
}

cargarPacientes();

// Activar/desactivar filtros
function toggleFiltro(campo) {
    filtros[campo] = !filtros[campo];

    const boton = document.getElementById("btn_" + campo);

    if (filtros[campo]) {
        boton.classList.add("filtro-activo");
    } else {
        boton.classList.remove("filtro-activo");
    }

    verSemana();
}

// Limpiar filtros
function limpiarFiltros() {
    filtros.mañana = false;
    filtros.tarde = false;
    filtros.control = false;
    filtros.paciente = "todos";

    document.getElementById("filtroPaciente").value = "todos";

    document.getElementById("btn_mañana").classList.remove("filtro-activo");
    document.getElementById("btn_tarde").classList.remove("filtro-activo");
    document.getElementById("btn_control").classList.remove("filtro-activo");

    verSemana();
}

// Cargar semana
async function cargarSemana(fechaBase) {
    const fecha = new Date(fechaBase);

    const lunes = new Date(fecha);
    lunes.setDate(fecha.getDate() - fecha.getDay() + 1);

    const domingo = new Date(lunes);
    domingo.setDate(lunes.getDate() + 6);

    const f1 = lunes.toISOString().split("T")[0];
    const f2 = domingo.toISOString().split("T")[0];

    const { data } = await client
        .from("registros_diarios")
        .select("*, pacientes(nombre)")
        .gte("fecha", f1)
        .lte("fecha", f2)
        .order("fecha", { ascending: true });

    return data || [];
}

// Agrupar por día
function agrupar(registros) {
    const dias = {};
    registros.forEach(r => {
        if (!dias[r.fecha]) dias[r.fecha] = [];
        dias[r.fecha].push(r);
    });
    return dias;
}

// Mostrar calendario
function mostrar(diasSemana) {
    const cont = document.getElementById("calendario");
    cont.innerHTML = "";

    const diasOrden = ["lunes","martes","miércoles","jueves","viernes",];
    const tabla = document.createElement("table");
    tabla.style.width = "100%";
    tabla.style.borderCollapse = "collapse";

    const head = document.createElement("tr");
    diasOrden.forEach(d => {
        const th = document.createElement("th");
        th.textContent = d.toUpperCase();
        th.style.border = "1px solid #ccc";
        th.style.padding = "8px";
        th.style.background = "#f0f0f0";
        head.appendChild(th);
    });
    tabla.appendChild(head);

    const fila = document.createElement("tr");
    const fechas = Object.keys(diasSemana).sort();

    diasOrden.forEach((_, i) => {
        const celda = document.createElement("td");
        celda.style.border = "1px solid #ccc";
        celda.style.padding = "8px";
        celda.style.verticalAlign = "top";

        const fecha = fechas[i];
        if (fecha) {
            const titulo = document.createElement("div");
            titulo.textContent = fecha;
            titulo.style.fontWeight = "bold";
            titulo.style.marginBottom = "6px";
            celda.appendChild(titulo);

            diasSemana[fecha].forEach(r => {

                // FILTRO POR PACIENTE
                if (filtros.paciente !== "todos" && r.paciente_id != filtros.paciente) return;

                // FILTROS OR (mañana, tarde, control)
                const algunFiltro = filtros.mañana || filtros.tarde || filtros.control;

                if (algunFiltro) {
                    let coincide = false;

                    if (filtros.mañana && r.mañana) coincide = true;
                    if (filtros.tarde && r.tarde) coincide = true;
                    if (filtros.control && r.control) coincide = true;

                    if (!coincide) return;
                }

                const p = document.createElement("div");
                p.style.background = "#eef5d0";
                p.style.padding = "4px";
                p.style.marginBottom = "6px";
                p.style.borderRadius = "4px";

                const nombre = r.pacientes?.nombre || "Sin nombre";
                const mañana = r.mañana ? "SÍ" : "NO";
                const tarde = r.tarde ? "SÍ" : "NO";
                const control = r.control ? "SÍ" : "NO";

                // Construcción dinámica del texto
                let texto = nombre;
                let detalles = [];

                if (filtros.mañana) detalles.push(`Mañana: ${mañana}`);
                if (filtros.tarde) detalles.push(`Tarde: ${tarde}`);
                if (filtros.control) detalles.push(`Control: ${control}`);

                if (detalles.length > 0) {
                    texto += " — " + detalles.join(" — ");
                }

                p.textContent = texto;

                celda.appendChild(p);
            });
        }

        fila.appendChild(celda);
    });

    tabla.appendChild(fila);
    cont.appendChild(tabla);
}

// Navegación
async function verSemana() {
    const registros = await cargarSemana(fechaActual);
    const dias = agrupar(registros);
    mostrar(dias);
}

function semanaAnterior() {
    fechaActual.setDate(fechaActual.getDate() - 7);
    verSemana();
}

function semanaSiguiente() {
    fechaActual.setDate(fechaActual.getDate() + 7);
    verSemana();
}

// Cargar al abrir
verSemana();
</script>

</body>
</html>



