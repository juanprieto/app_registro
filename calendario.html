<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Calendario Semanal (Safari Fix)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* Mismo CSS */
.filtro-activo { background-color: #4CAF50; color: white; font-weight: bold; }
#auth-section { margin-bottom: 15px; }
.hidden { display: none; }
.dia-semana { font-weight: bold; margin-bottom: 6px; }
#refresh-btn { background: orange; margin-left: 10px; }
</style>
</head>

<body>

<h2>Calendario semanal <button id="refresh-btn" onclick="forceRefresh()" title="Safari Fix">游댃 Refrescar</button></h2>

<!-- Resto igual: auth, filtros, botones... -->
<div id="auth-section">
    <button id="btn-login" onclick="login()">Iniciar Sesi칩n</button>
    <button id="btn-logout" onclick="logout()" class="hidden">Cerrar Sesi칩n</button>
    <p id="user-info"></p>
</div>

<div style="margin-bottom: 15px;">
    <label>Paciente:</label>
    <select id="filtroPaciente"><option value="todos">Todos</option></select>
    <button id="btn_ma침ana" onclick="toggleFiltro('ma침ana')">Ma침ana</button>
    <button id="btn_tarde" onclick="toggleFiltro('tarde')">Tarde</button>
    <button id="btn_control" onclick="toggleFiltro('control')">Control</button>
    <button onclick="limpiarFiltros()">Limpiar</button>
</div>

<button onclick="semanaAnterior()">拘勇 Anterior</button>
<span id="rango-semana"></span>
<button onclick="semanaSiguiente()">Siguiente 俱뫮잺</button>

<div id="calendario"></div>

<script>
// Cache-bust URL para Safari
const CACHE_BUST = `?v=${Date.now()}`;
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let fechaActual = new Date();
let session = null;
let isRefreshing = false;
let pollInterval = null;
const DIAS_SEMANA = ["lunes", "martes", "mi칠rcoles", "jueves", "viernes", "s치bado", "domingo"];

// **FIX SAFARI: Refresh forzado**
function forceRefresh() {
    if (isRefreshing) return;
    isRefreshing = true;
    document.getElementById('calendario').innerHTML = '<p>Refrescando...</p>';
    
    // Limpiar localStorage Safari
    localStorage.removeItem('supabase.auth.token');
    
    // Recrear client y re-autenticar
    initAuth().then(() => {
        setTimeout(() => {
            verSemana();
            isRefreshing = false;
        }, 500);
    });
}

// **FIX SAFARI: Polling fallback para session**
async function checkSession() {
    const {  { session: newSession } } = await client.auth.getSession();
    if (newSession !== session) {
        session = newSession;
        initAuth();
    }
}

// Auth con polling Safari
async function initAuth() {
    const {  { session: sess } } = await client.auth.refreshSession();
    session = sess;
    
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userInfo = document.getElementById('user-info');

    if (session) {
        btnLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');
        userInfo.textContent = `Usuario: ${session.user.email}`;
        
        // Polling cada 30s solo en Safari
        if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(checkSession, 30000);
        }
        
        cargarPacientes();
        verSemana();
    } else {
        btnLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
        userInfo.textContent = 'Inicia sesi칩n';
        if (pollInterval) clearInterval(pollInterval);
    }

    // Listener mejorado
    client.auth.onAuthStateChange(async (event, sess) => {
        session = sess;
        await initAuth();
    });
}

// Resto de funciones iguales (cargarPacientes, toggleFiltro, etc.)
async function cargarPacientes() {
    if (!session) return;
    const { data } = await client.from("pacientes").select("id, nombre").order("nombre");
    const sel = document.getElementById("filtroPaciente");
    sel.innerHTML = '<option value="todos">Todos</option>';
    data?.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.nombre;
        sel.appendChild(opt);
    });
    sel.onchange = () => { filtros.paciente = sel.value; verSemana(); };
}

function toggleFiltro(campo) {
    filtros[campo] = !filtros[campo];
    document.getElementById("btn_" + campo).classList.toggle("filtro-activo", filtros[campo]);
    verSemana();
}

function limpiarFiltros() {
    Object.keys(filtros).forEach(k => filtros[k] = k === 'paciente' ? 'todos' : false);
    document.getElementById("filtroPaciente").value = "todos";
    document.querySelectorAll('[id^="btn_"]').forEach(btn => btn.classList.remove("filtro-activo"));
    verSemana();
}

function calcularFechasSemana(fechaBase) {
    const fecha = new Date(fechaBase);
    const diaSemana = fecha.getDay() === 0 ? 7 : fecha.getDay();
    const lunes = new Date(fecha);
    lunes.setDate(fecha.getDate() - (diaSemana - 1));
    const fechas = [];
    for (let i = 0; i < 7; i++) {
        const f = new Date(lunes);
        f.setDate(lunes.getDate() + i);
        fechas.push(f.toISOString().split('T')[0]);
    }
    return fechas;
}

async function cargarSemana(fechaBase) {
    if (!session) return [];
    const fechasSemana = calcularFechasSemana(fechaBase);
    const f1 = fechasSemana[0];
    const f2 = fechasSemana[6];

    let query = client.from("registros_diarios").select("*, pacientes(nombre)").gte("fecha", f1).lte("fecha", f2).order("fecha");

    if (filtros.paciente !== "todos") query.eq("paciente_id", filtros.paciente);
    if (filtros.ma침ana) query.eq("ma침ana", true);
    if (filtros.tarde) query.eq("tarde", true);
    if (filtros.control) query.eq("control", true);

    const { data } = await query;
    return data || [];
}

// mostrar() igual que antes...
// (omitido por brevedad, usa el mismo de la versi칩n anterior)

async function verSemana() {
    if (!session) return;
    const registros = await cargarSemana(fechaActual);
    const dias = agrupar(registros);
    mostrar(dias);
}

function semanaAnterior() { fechaActual.setDate(fechaActual.getDate() - 7); verSemana(); }
function semanaSiguiente() { fechaActual.setDate(fechaActual.getDate() + 7); verSemana(); }

// **IMPORTANTE: Inicializar con refresh forzado**
window.addEventListener('load', () => {
    setTimeout(initAuth, 100); // Delay para Safari
});

// Deshabilitar service worker Safari
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => {
        regs.forEach(reg => reg.unregister());
    });
}
</script>

</body>
</html>




