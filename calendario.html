<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Semanal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.filtro-activo {
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
   } 

.sustancia-neg {
    color: #0a730a;      /* verde oscuro */
    font-weight: bold;
}

.sustancia-pos {
    color: #c00000;      /* rojo */
    font-weight: bold;

}
</style>
</head>

<body>

<h2>Calendario semanal</h2>

<!-- Filtros -->
<div style="margin-bottom: 15px;">

    <label>Paciente:</label>
    <select id="filtroPaciente">
        <option value="todos">Todos</option>
    </select>

    <button id="btn_mañana" onclick="toggleFiltro('mañana')">Mañana</button>
    <button id="btn_tarde" onclick="toggleFiltro('tarde')">Tarde</button>
    <button id="btn_control" onclick="toggleFiltro('control')">Control</button>

    <button onclick="limpiarFiltros()">Limpiar filtros</button>

</div>

<button onclick="semanaAnterior()">⬅️ Semana anterior</button>
<button onclick="semanaSiguiente()">➡️ Semana siguiente</button>

<div id="calendario" style="margin-top:20px;"></div>

<script>
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Fecha interna del calendario
let fechaActual = new Date();

// Filtros activos
let filtros = {
    mañana: false,
    tarde: false,
    control: false,
    paciente: "todos"
};

// ---- MAPA DE SUSTANCIAS ----
const mapaSustancias = {
    0: "Negativo",
    2: "Positivo"
};

// ---- UTILIDADES DE FECHA ----
function formatearFechaLocal(fecha) {
    const d = new Date(fecha);
    const año = d.getFullYear();
    const mes = String(d.getMonth() + 1).padStart(2, "0");
    const dia = String(d.getDate()).padStart(2, "0");
    return `${año}-${mes}-${dia}`;
}

function obtenerLunes(fecha) {
    const d = new Date(fecha);
    const dia = d.getDay(); // 0=domingo, 1=lunes...
    const diferencia = (dia === 0) ? -6 : (1 - dia);
    d.setDate(d.getDate() + diferencia);
    return d;
}

// ---- DESCRIPCIÓN DE SUSTANCIAS ----
function describirSustancias(json) {
    if (!json) return "";

    const resultado = [];

    for (const clave in json) {
        const valor = json[clave];

        // Solo mostrar 0 y 2
       if (valor === 0) {
            resultado.push(`<span class="sustancia-neg">${clave}: Negativo</span>`);
        }

        if (valor === 2) {
            resultado.push(`<span class="sustancia-pos">${clave}: Positivo</span>`);
        }
    }

    return resultado.join(" — ");
}

// Cargar lista de pacientes
async function cargarPacientes() {
    const { data } = await client
        .from("pacientes")
        .select("id, nombre")
        .order("nombre", { ascending: true });

    const sel = document.getElementById("filtroPaciente");

    data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        sel.appendChild(opt);
    });

    sel.onchange = () => {
        filtros.paciente = sel.value;
        verSemana();
    };
}

cargarPacientes();

// Activar/desactivar filtros
function toggleFiltro(campo) {
    filtros[campo] = !filtros[campo];

    const boton = document.getElementById("btn_" + campo);

    if (filtros[campo]) {
        boton.classList.add("filtro-activo");
    } else {
        boton.classList.remove("filtro-activo");
    }

    verSemana();
}

// Limpiar filtros
function limpiarFiltros() {
    filtros.mañana = false;
    filtros.tarde = false;
    filtros.control = false;
    filtros.paciente = "todos";

    document.getElementById("filtroPaciente").value = "todos";

    document.getElementById("btn_mañana").classList.remove("filtro-activo");
    document.getElementById("btn_tarde").classList.remove("filtro-activo");
    document.getElementById("btn_control").classList.remove("filtro-activo");

    verSemana();
}

// Cargar semana (solo lunes-viernes)
async function cargarSemana(fechaBase) {
    const lunes = obtenerLunes(fechaBase);
    const viernes = new Date(lunes);
    viernes.setDate(lunes.getDate() + 4);

    const f1 = formatearFechaLocal(lunes);
    const f2 = formatearFechaLocal(viernes);

    const { data } = await client
        .from("registros_diarios")
        .select("*, pacientes(nombre)")
        .gte("fecha", f1)
        .lte("fecha", f2)
        .order("fecha", { ascending: true });

    return data || [];
}

// Agrupar por día (solo lunes-viernes)
function agrupar(registros) {
    const dias = {};
    registros.forEach(r => {
        const clave = r.fecha; // YYYY-MM-DD
        const d = new Date(clave).getDay();
        if (d >= 1 && d <= 5) {
            if (!dias[clave]) dias[clave] = [];
            dias[clave].push(r);
        }
    });
    return dias;
}

// Mostrar calendario
function mostrar(diasSemana) {
    const cont = document.getElementById("calendario");
    cont.innerHTML = "";

    const diasOrden = ["lunes","martes","miércoles","jueves","viernes"];
    const tabla = document.createElement("table");
    tabla.style.width = "100%";
    tabla.style.borderCollapse = "collapse";

    // Cabecera
    const head = document.createElement("tr");
    diasOrden.forEach(d => {
        const th = document.createElement("th");
        th.textContent = d.toUpperCase();
        th.style.border = "1px solid #ccc";
        th.style.padding = "8px";
        th.style.background = "#f0f0f0";
        head.appendChild(th);
    });
    tabla.appendChild(head);

    // Fechas reales lunes–viernes de la semana actual
    const lunes = obtenerLunes(fechaActual);
    const fechas = [];

    for (let i = 0; i < 5; i++) {
        const d = new Date(lunes.getTime()); // CLON CORRECTO
        d.setDate(d.getDate() + i);          // avanzar desde el clon
        fechas.push(formatearFechaLocal(d));
    }

    const fila = document.createElement("tr");

    fechas.forEach(fecha => {
        const celda = document.createElement("td");
        celda.style.border = "1px solid #ccc";
        celda.style.padding = "8px";
        celda.style.verticalAlign = "top";

        const titulo = document.createElement("div");
        titulo.textContent = fecha;
        titulo.style.fontWeight = "bold";
        titulo.style.marginBottom = "6px";
        celda.appendChild(titulo);

        // ← BOTÓN DE OBSERVACIONES GENERALES DEL DÍA
const btnObsDia = document.createElement("button");
btnObsDia.textContent = "Observaciones";
btnObsDia.style.marginBottom = "6px";
btnObsDia.style.display = "block";

btnObsDia.onclick = () => {
    // Buscar la observación del día (solo una)
    const registrosDia = diasSemana[fecha] || [];
    const obs = registrosDia.length > 0 ? (registrosDia[0].observaciones || "Sin observaciones") : "Sin observaciones";
    alert(obs);
};

celda.appendChild(btnObsDia);

        

        const registros = diasSemana[fecha] || [];

        registros.forEach(r => {

            // FILTRO PACIENTE
            if (filtros.paciente !== "todos" && r.paciente_id != filtros.paciente) return;

            // FILTROS OR reales
            const activos = [];
            if (filtros.mañana) activos.push(r.mañana);
            if (filtros.tarde) activos.push(r.tarde);
            if (filtros.control) activos.push(r.control);

            if (activos.length > 0 && !activos.includes(true)) return;

            const p = document.createElement("div");
            p.style.background = "#eef5d0";
            p.style.padding = "4px";
            p.style.marginBottom = "6px";
            p.style.borderRadius = "4px";

            const nombre = r.pacientes?.nombre || "Sin nombre";
            const mañana = r.mañana ? "SÍ" : "NO";
            const tarde = r.tarde ? "SÍ" : "NO";
            const control = r.control ? "SÍ" : "NO";

            let texto = nombre;
            let detalles = [];

            if (filtros.mañana) detalles.push(`Mañana: ${mañana}`);
            if (filtros.tarde) detalles.push(`Tarde: ${tarde}`);
            if (filtros.control) detalles.push(`Control: ${control}`);

            if (detalles.length > 0) {
                texto += " — " + detalles.join(" — ");
            }

            // Añadir sustancias (solo 0 y 2)
            const sustanciasTexto = describirSustancias(r.sustancias);
            if (sustanciasTexto) {
                texto += " — " + sustanciasTexto;
            }

            p.innerHTML = texto;

            celda.appendChild(p);
        });

        fila.appendChild(celda);
    });

    tabla.appendChild(fila);
    cont.appendChild(tabla);
}

// Navegación
async function verSemana() {
    const registros = await cargarSemana(fechaActual);
    const dias = agrupar(registros);
    mostrar(dias);
}

function semanaAnterior() {
    fechaActual.setDate(fechaActual.getDate() - 7);
    verSemana();
}

function semanaSiguiente() {
    fechaActual.setDate(fechaActual.getDate() + 7);
    verSemana();
}

// Cargar al abrir
verSemana();
</script>

</body>
</html>






