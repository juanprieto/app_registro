<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Asistencia - Tesis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

    <link rel="icon" type="image/png" href="logo.png">

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1250px; margin: auto; padding: 10px; background-color: #f8f9fa; }
        h1 { text-align: center; color: rgb(167, 188, 75); border-bottom: 2px solid rgb(167, 188, 75); padding-bottom: 10px; }
        
        #bloqueoInicio { position: fixed; inset: 0; background: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 12px 2px; text-align: center; overflow: hidden; font-size: 13px; }
        
        .col-paciente { width: 160px; }
        .col-check { width: 45px; }
        .col-novino { width: 140px; }
        .col-resultados { width: 130px; }
        .col-riesgo { width: 120px; }

        #tbody td:first-child input { font-size: 15px !important; font-weight: bold; border: none; width: 100%; background: transparent; }
        select { width: 95%; padding: 4px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        button { background: rgb(167, 188, 75); color: white; padding: 12px 20px; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .btn-export { background-color: rgb(167, 188, 75) !important; font-size: 20px; padding: 25px; width: 100%; margin-top: 20px; }
        
        input[type="checkbox"] { width: 26px; height: 26px; cursor: pointer; vertical-align: middle; }

        .bg-verde { background-color: #d4edda !important; }
        .bg-amarillo { background-color: #fff3cd !important; }
        .bg-naranja { background-color: #ffe5b4 !important; }
        .bg-rojo { background-color: #f8d7da !important; }
        
        .logo-container { text-align: center; margin-bottom: 10px; }
        .logo-img { max-width: 220px; height: auto; }
        
        .motivo-select { display: none; margin-top: 5px; }
        .motivo-select.visible { display: block; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 30px; width: 85%; max-width: 450px; border-radius: 12px; text-align: center; }
    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<script>
const SUPABASE_URL = "https://gqyqpdcavqgcyaoidulj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeXFwZGNhdnFnY3lhb2lkdWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Nzk5MzIsImV4cCI6MjA4NDU1NTkzMn0.nHu3OIS8S20thJxUmVVybb7Ox5B2qkhv7qxc1X2Va7g";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

</script>

<body>

    <div id="bloqueoInicio">
        <div class="logo-container">
           <img src="logo.png" alt="logo">
</div>
        <h2 style="color: rgb(167, 188, 75);">NUEVO REGISTRO DIARIO</h2>
        <p>Confirma la fecha para comenzar:</p>
        <input type="date" id="fechaConfirmar" style="font-size: 25px; padding: 10px; border: 2px solid rgb(167, 188, 75); border-radius: 8px;">
        <br><br>
        <button onclick="confirmarFechaInicial()" style="padding: 20px 40px; font-size: 20px;">‚úÖ EMPEZAR</button>
    </div>

    <div class="logo-container">
       <img src="logo.png" alt="logo">
 </div>

    <h1>Control Terap√©utico Diario</h1>
    <div style="margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 20px;">
        <label>FECHA:</label> 
        <input type="date" id="fecha" disabled style="font-size: 18px; border:none; font-weight:bold;">
        <button onclick="agregarPaciente()">‚ûï Paciente Extra</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th class="col-paciente">Paciente</th>
                <th class="col-check">M</th>
                <th class="col-check">T</th>
                <th class="col-novino">No Vino (Motivo)</th>
                <th class="col-check">Ctrl</th>
                <th class="col-resultados">Resultados</th>
                <th class="col-check">Resc</th>
                <th class="col-check">Med</th>
                <th class="col-riesgo">Riesgo</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
    <div style="margin-top: 25px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
    <h3 style="color: rgb(167, 188, 75); margin-top: 0;">Observaciones del d√≠a</h3>
    <textarea id="observaciones" 
              placeholder="Escribe aqu√≠ notas para el cambio de turno, incidencias, avisos, recordatorios..."
              style="width: 100%; height: 120px; font-size: 15px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: vertical;"></textarea>
</div>

    <button class="btn-export" onclick="exportarExcel()">üíæ EXPORTAR Y FINALIZAR D√çA</button>
   


    <div id="modalControles" class="modal">
        <div class="modal-content">
            <h3 style="color:rgb(167, 188, 75)">Test de T√≥xicos</h3>
            <p id="modalPaciente"></p>
            <div id="controlesInputs">
            <p>COC:
                <select id="m_COC">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>OH:
                <select id="m_OH">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>THC:
                <select id="m_THC">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>BZD:
                <select id="m_BZD">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>OPI:
                <select id="m_OPI">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>KETA:
                <select id="m_KETA">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>AMP:
                <select id="m_AMP">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>

            <p>MTD:
                <select id="m_MTD">
                    <option value="2"></option>
                    <option value="0">NEGATIVO</option>
                    <option value="1">POSITIVO</option>
                    <option value="2">NO REALIZADO</option>
                </select>
            </p>
                
            </div>
            <br>
            <button onclick="guardarControles()" style="width:100%">GUARDAR</button>
            <button onclick="cerrarModal()" style="background:#666; width:100%; margin-top:10px">CERRAR</button>
        </div>
    </div>

    <script>
        const LISTA_BASE = ["Alan Mollica", "Amadeu Andres", "Anastasia Valls", "Antonio Gutierrez", "Carlos Ezquerra", "Carlos Palomar", "Cesar Gavilan", "Concha Rodriguez", "Dani Urgelles", "Eduard de la Torre", "Eva Alvarez", "Ferran Serrano", "Francesc Ordeig", "Ignasi Martin (Nacho)", "Ivan Pueyo", "Jacinto Texido", "Javier Sanz", "Jordi Homs", "Jordi Navarro", "Jordi Ortuno", "Jordi Perez", "Juanma Reboll", "Laury Gallardo", "Marc Garrell", "Marc Gonzalez", "Maria Munoz", "Mario Shefer", "Massinissa Ait-Ahmed", "Oscar Leal", "Pol Ribot", "Puri Galiot", "Rosa Tella", "Sara Alguacil", "Sergio Funes", "Vicente Vega", "Vicky Iglesias"];
        // Pacientes que deben tomar medicaci√≥n
        const PACIENTES_CON_MEDICACION = [
    "Anastasia Valls","Antonio Gutierrez", 
    "Alan Mollica","Concha Rodriguez", 
    "Dani Urgelles","Francesc Ordeig", "Ivan Pueyo", 
    "Jordi Homs", "Marc Gonzalez",
    "Massinissa Ait-Ahmed", 
];

        const STORAGE_KEY = 'asistencia_v7_base64';
        let filaActiva = null;

        window.addEventListener('DOMContentLoaded', () => {
            const memoria = localStorage.getItem(STORAGE_KEY);
            if (memoria) {
                const data = JSON.parse(memoria);
                document.getElementById('fecha').value = data.fecha;
                data.filas.forEach(f => restaurarFila(f));
                document.getElementById('bloqueoInicio').style.display = 'none';
            } else {
                document.getElementById('fechaConfirmar').valueAsDate = new Date();
                document.getElementById('bloqueoInicio').style.display = 'flex';
                cargarListaDefault();
            }
        });

        function confirmarFechaInicial() {
            const fVal = document.getElementById('fechaConfirmar').value;
            if(!fVal) return alert("Selecciona fecha");
            document.getElementById('fecha').value = fVal;
            document.getElementById('bloqueoInicio').style.display = 'none';
            autoGuardar();
        }

        function pintarCeldaCheck(el) {
            const td = el.parentElement;
            td.className = el.checked ? 'bg-verde' : 'bg-amarillo';
            autoGuardar();
        }

        function pintarCeldaEscala(select) {
            const td = select.parentElement;
            td.classList.remove('bg-verde', 'bg-amarillo', 'bg-naranja', 'bg-rojo');
            const val = select.value;
            if(val == "0") td.classList.add('bg-verde');
            else if(val == "1") td.classList.add('bg-amarillo');
            else if(val == "2") td.classList.add('bg-naranja');
            else if(val == "3") td.classList.add('bg-rojo');
            autoGuardar();
        }

        function pintarCeldaResultado(td) {
            const texto = td.textContent;
            td.classList.remove('bg-verde', 'bg-rojo');
            if(texto === "-") return;
            if(texto.includes("POS")) td.classList.add('bg-rojo');
            else td.classList.add('bg-verde');
        }
function marcarMedicacion(cb) {
    const td = cb.parentElement;
    const nombre = cb.closest("tr").cells[0].querySelector("input").value.trim();

    if (cb.checked) {
        td.classList.remove("bg-rojo");
        td.classList.add("bg-verde");
    } else {
        if (PACIENTES_CON_MEDICACION.includes(nombre)) {
            td.classList.remove("bg-verde");
            td.classList.add("bg-rojo");
        } else {
            td.classList.remove("bg-verde", "bg-rojo");
        }
    }

    autoGuardar();
}
async function guardarRegistroEnSupabase(registro) {
    const { data, error } = await client
        .from("registros_diarios")
        .insert(registro);

    if (error) {
        console.error("Error guardando en Supabase:", error);
    } else {
        console.log("Registro guardado en Supabase:", data);
    }
}


        function agregarPaciente(nombre = '') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${nombre}" oninput="autoGuardar()"></td>
                <td class="bg-amarillo"><input type="checkbox" onchange="pintarCeldaCheck(this)"></td>
                <td class="bg-amarillo"><input type="checkbox" onchange="pintarCeldaCheck(this)"></td>
                <td><input type="checkbox" onchange="toggleMotivo(this)">
                    <select class="motivo-select" onchange="pintarCeldaEscala(this)">
                        <option value="0">Hoy no toca</option><option value="1">No justifica</option><option value="2">No quiere venir</option><option value="3">Reca√≠do</option>
                    </select>
                </td>
                <td class="bg-amarillo"><input type="checkbox" onchange="abrirModal(this); pintarCeldaCheck(this);"></td>
                <td style="font-size:10px;">-</td>
                <td><input type="checkbox" onchange="autoGuardar()"></td>
                <td><input type="checkbox" class="medicacion" onchange="marcarMedicacion(this)"></td>

                <td class="bg-verde"><select onchange="pintarCeldaEscala(this)"><option value="0">BIEN</option><option value="1">REGULAR</option><option value="2">MAL</option><option value="3">RECA√çDA</option>
                    </select>
                </td>
            `;
            document.getElementById('tbody').appendChild(tr);
            // --- Colorear casilla MED si el paciente debe medicarse ---
            const nombrePaciente = nombre.trim();
            const celdaMed = tr.cells[7];

if (PACIENTES_CON_MEDICACION.includes(nombrePaciente)) {
    celdaMed.classList.add("bg-rojo"); // rojo claro
}

        }

        function restaurarFila(f) {
            agregarPaciente(f.pac);
            const tr = document.getElementById('tbody').lastElementChild;
            const cM = tr.cells[1].querySelector('input'); cM.checked = f.m; pintarCeldaCheck(cM);
            const cT = tr.cells[2].querySelector('input'); cT.checked = f.t; pintarCeldaCheck(cT);
            const selNV = tr.cells[3].querySelector('select');
            if(f.nv) { 
                tr.cells[3].querySelector('input').checked = true; 
                selNV.classList.add('visible'); 
                selNV.value = f.mot; 
                pintarCeldaEscala(selNV);
            }
            const cC = tr.cells[4].querySelector('input'); cC.checked = f.c; pintarCeldaCheck(cC);
            tr.cells[5].textContent = f.res; pintarCeldaResultado(tr.cells[5]);
            tr.cells[6].querySelector('input').checked = f.rs;
            tr.cells[7].querySelector('input').checked = f.md;
            const selR = tr.cells[8].querySelector('select');
            selR.value = f.rg;
            pintarCeldaEscala(selR);
        }

        function cargarListaDefault() {
            document.getElementById('tbody').innerHTML = '';
            LISTA_BASE.sort().forEach(n => agregarPaciente(n));
        }

        function autoGuardar() {
            const f = document.getElementById('fecha').value;
            if(!f) return;
            const filas = Array.from(document.querySelectorAll('#tbody tr')).map(tr => ({
                pac: tr.cells[0].querySelector('input').value,
                m: tr.cells[1].querySelector('input').checked,
                t: tr.cells[2].querySelector('input').checked,
                nv: tr.cells[3].querySelector('input').checked,
                mot: tr.cells[3].querySelector('select').value,
                c: tr.cells[4].querySelector('input').checked,
                res: tr.cells[5].textContent,
                rs: tr.cells[6].querySelector('input').checked,
                md: tr.cells[7].querySelector('input').checked,
                rg: tr.cells[8].querySelector('select').value
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ fecha: f, filas: filas }));
        }

        function toggleMotivo(cb) { 
            const sel = cb.nextElementSibling;
            sel.classList.toggle('visible', cb.checked);
            if(!cb.checked) cb.parentElement.className = '';
            else pintarCeldaEscala(sel);
            autoGuardar(); 
        }

        function abrirModal(cb) {
            filaActiva = cb.closest('tr');
            document.getElementById('modalPaciente').textContent = filaActiva.cells[0].querySelector('input').value;
            const IDs = ['m_COC', 'm_OH', 'm_THC', 'm_BZD', 'm_OPI', 'm_KETA', 'm_AMP', 'm_MTD'];
            IDs.forEach(id => document.getElementById(id).value = "");
            document.getElementById('modalControles').style.display = 'block';
        }

        function cerrarModal() { document.getElementById('modalControles').style.display = 'none'; }

        function guardarControles() {
            const IDs = ['m_COC', 'm_OH', 'm_THC', 'm_BZD', 'm_OPI', 'm_KETA', 'm_AMP', 'm_MTD'];
            let res = IDs.map(id => {
                const v = document.getElementById(id).value;
                return v ? `${id.replace('m_','')}:${v}` : null;
            }).filter(x => x).join(', ');
            filaActiva.cells[5].textContent = res || '-';
            pintarCeldaResultado(filaActiva.cells[5]);
            cerrarModal();
            autoGuardar();
        }
        async function obtenerPacienteId(nombre) {
    // 1. Buscar paciente por nombre
    const { data, error } = await client
        .from("pacientes")
        .select("id")
        .eq("nombre", nombre)
        .maybeSingle();

    if (error) {
        console.error("Error buscando paciente:", error);
        return null;
    }

    // 2. Si existe, devolver su id
    if (data) {
        return data.id;
    }

    // 3. Si no existe, crearlo autom√°ticamente
    const { data: nuevo, error: errorInsert } = await client
        .from("pacientes")
        .insert({
            nombre: nombre,
            activo: true,
            medicacion: false
        })
        .select()
        .single();

    if (errorInsert) {
        console.error("Error creando paciente:", errorInsert);
        return null;
    }

    return nuevo.id;
}
        // üîπ Obtener o crear paciente en Supabase
async function obtenerPacienteId(nombre) {
    if (!nombre) return null;

    // Buscar si ya existe
    const { data, error } = await client
        .from("pacientes")
        .select("id")
        .eq("nombre", nombre)
        .maybeSingle();

    if (error) {
        console.error("Error buscando paciente:", error);
        return null;
    }

    if (data) return data.id;

    // Crear si no existe
    const { data: nuevo, error: errorInsert } = await client
        .from("pacientes")
        .insert({ nombre, activo: true })
        .select()
        .single();

    if (errorInsert) {
        console.error("Error creando paciente:", errorInsert);
        return null;
    }

    return nuevo.id;
}

// üîπ Guardar paciente al salir del input
async function guardarPacienteDesdeFila(input) {
    const nombre = input.value.trim();
    if (!nombre) return;

    const id = await obtenerPacienteId(nombre);
    input.closest("tr").dataset.pacienteId = id;
}


async function exportarExcel() {
    const fISO = document.getElementById('fecha').value;
    const [y, m, d] = fISO.split('-');
    const fBonita = `${d}/${m}/${y}`;

    if (!confirm(`¬øExportar informe de fecha ${fBonita}?`)) return;

    // üîπ 1. Extraer datos de la tabla
    const data = Array.from(document.querySelectorAll('#tbody tr')).map(tr => {
        const res = tr.cells[5].textContent;

        const check = (sust) => {
            if (!res || res === "-") return 1;
            if (res.includes(`${sust}:POS`)) return 2;
            if (res.includes(`${sust}:NEG`)) return 0;
            return 1;
        };

        return {
            "FECHA": fBonita,
            "PACIENTE": tr.cells[0].querySelector('input').value,
            "ASISTENCIA": tr.cells[3].querySelector('input').checked ? tr.cells[3].querySelector('select').value : 0,
            "MA√ëANA": tr.cells[1].querySelector('input').checked ? "SI" : "NO",
            "TARDE": tr.cells[2].querySelector('input').checked ? "SI" : "NO",
            "CONTROL": tr.cells[4].querySelector('input').checked ? "SI" : "NO",
            "COC": check("COC"), "OH": check("OH"), "THC": check("THC"), "BZD": check("BZD"),
            "OPI": check("OPI"), "KETA": check("KETA"), "AMP": check("AMP"), "MTD": check("MTD"),
            "RESCATE": tr.cells[6].querySelector('input').checked ? "SI" : "NO",
            "MEDICACI√ìN": tr.cells[7].querySelector('input').checked ? "SI" : "NO",
            "RIESGO": tr.cells[8].querySelector('select').value
            "OBSERVACIONES": document.getElementById("observaciones")?.value || ""
        };
    });

    // üîπ 2. Obtener todos los nombres de pacientes
    const nombres = data.map(f => f.PACIENTE);

    // üîπ 3. Obtener IDs de pacientes en una sola llamada
    const { data: pacientes, error: errorPac } = await client
        .from("pacientes")
        .select("id, nombre")
        .in("nombre", nombres);

    if (errorPac) {
        alert("Error obteniendo IDs de pacientes");
        console.error(errorPac);
        return;
    }

    // üîπ 4. Crear diccionario nombre ‚Üí id
    const mapaPacientes = {};
    pacientes.forEach(p => mapaPacientes[p.nombre] = p.id);

    // üîπ 5. Preparar registros para inserci√≥n masiva
    const registros = data.map(fila => ({
        fecha: fISO,
        paciente_id: mapaPacientes[fila.PACIENTE],
        asistencia: fila.ASISTENCIA,
        ma√±ana: fila.MA√ëANA === "SI",
        tarde: fila.TARDE === "SI",
        control: fila.CONTROL === "SI",
        sustancias: {
            COC: fila.COC,
            OH: fila.OH,
            THC: fila.THC,
            BZD: fila.BZD,
            OPI: fila.OPI,
            KETA: fila.KETA,
            AMP: fila.AMP,
            MTD: fila.MTD
        },
        rescate: fila.RESCATE === "SI",
        medicacion: fila["MEDICACI√ìN"] === "SI",
        riesgo: fila.RIESGO,
        observaciones: document.getElementById("observaciones")?.value || ""
    }));

    // üîπ 6. Insertar TODO en una sola llamada
    const { error: errorInsert } = await client
        .from("registros_diarios")
        .insert(registros);

    if (errorInsert) {
        alert("Error guardando registros en Supabase");
        console.error(errorInsert);
        return;
    }

    // üîπ 7. Exportar Excel compatible con Android/Samsung
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Tesis");

    // Generar el archivo como ArrayBuffer
    const excelBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });

    // Convertir a Blob
    const blob = new Blob([excelBuffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    // Descargar usando FileSaver (compatible con Android)
    saveAs(blob, `Registro_${fISO}.xlsx`);

    // üîπ 8. Preguntar si limpiar pantalla
    setTimeout(() => {
        if (confirm("¬øFinalizar d√≠a y limpiar pantalla?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }, 500);
}




        
    </script>
</body>
</html>

   
